---
- name: Install hedgedoc
  become: true
  become_user: "{{ hedgedoc_user }}"
  block:
    - name: Checkout source
      ansible.builtin.git:
        repo: https://github.com/hedgedoc/hedgedoc.git
        dest: "{{ hedgedoc_home }}"
        version: "{{ hedgedoc_version }}"
      notify: restart hedgedoc
      register: git_result
    - name: Install dependency packages && build
      when: git_result is changed
      block:
        - name: Install dependency packages(build)
          ansible.builtin.command:
            cmd: yarn install --frozen-lockfile
            chdir: "{{ hedgedoc_home }}"
        - name: Execute build
          ansible.builtin.command:
            cmd: yarn build
            chdir: "{{ hedgedoc_home }}"
          notify: restart hedgedoc
        - name: Install dependency packages(production)
          ansible.builtin.command:
            cmd: yarn install --production=true --frozen-lockfile
            chdir: "{{ hedgedoc_home }}"
